<div class="quiz-container">
  <div class="quiz-progress-container">
    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
  </div>
  <div id="quiz-question-container"></div>

  <div id="quiz-navigation-container">
    <button
      class="quiz-navbutton"
      id="quiz-prev-question"
      style="display: none"
    >
      Previous
    </button>
    <button class="quiz-navbutton" id="quiz-next-question">Next</button>
  </div>
</div>

<script>
  const languageOptions = [
    "Python",
    "Java",
    "C++",
    "Go",
    "TypeScript",
    "JavaScript",
    "C#",
    "Ruby",
    "PHP",
    "Swift",
    "Kotlin",
    "Other",
  ];

  {{ body | safe }}

  let answers = {};
  const progressBar = document.getElementById("progress-bar");
  let totalQuestions = questions.length;
  let currentQuestionIndex = 1;

  document
    .getElementById("quiz-next-question")
    .addEventListener("click", () => {
      nextQuestion();
    });

  function nextQuestion() {
    // Get the quiz container and store the user's answers
    const quizContainer = document.getElementById("quiz-question-container");
    const inputs = quizContainer.querySelectorAll(
      "input[type='text'], input[type='email'], input[type='radio'], input[type='checkbox']"
    );

    inputs.forEach((input) => {
      if (input.type === "radio" || input.type === "email") {
        if (input.checked) {
          answers[input.name] = input.value;
        }
      } else if (input.type === "checkbox") {
        if (input.checked) {
          if (!answers[input.name]) {
            answers[input.name] = [];
          }
          answers[input.name].push(input.value);
        }
      } else {
        answers[input.id] = input.value;
      }
    });

    console.log(answers);

    if (currentQuestionIndex < questions.length) {
      displayQuestion(currentQuestionIndex++);
    } else {
      // All questions have been answered
      submitQuiz();
    }
  }

  function previousQuestion() {
    if (currentQuestionIndex > 0) {
      displayQuestion(--currentQuestionIndex - 1);
    }
  }

  document
    .getElementById("quiz-prev-question")
    .addEventListener("click", () => {
      previousQuestion();
    });

  function updateProgressBar() {
    const progressPercentage = (currentQuestionIndex / totalQuestions) * 100;
    progressBar.style.width = `${progressPercentage}%`;
  }

  function displayQuestion(index) {
    history.pushState(
      { index: index },
      `Question ${index}`,
      `?question=${index}`
    );

    updateProgressBar();

    const questionContainer = document.getElementById(
      "quiz-question-container"
    );
    questionContainer.innerHTML = ""; // Clear existing content

    const question = questions[index];
    const questionElement = document.createElement("div");
    questionElement.className = "question";

    if (question.optional) {
      questionElement.innerHTML = `<h2>${question.question} (Optional)</h2>`;
    } else {
      questionElement.innerHTML = `<h2>${question.question}</h2>`;
    }

    // Initially hide the navigation buttons for 'radio' type questions
    const navContainer = document.getElementById("quiz-navigation-container");

    // Hide navContainer for first question
    // if (index === 0) {
    //   navContainer.style.display = "none";
    // } else {
    navContainer.style.display = "flex";
    // }

    document.getElementById("quiz-next-question").disabled = !question.optional;

    let inputElement;

    switch (question.type) {
      case "multipleChoice":
        const gridContainer = document.createElement("div");

        // Set the direction if specified
        if (question.direction) {
          gridContainer.style.display = "flex";
          gridContainer.style.flexDirection = question.direction;
        } else {
          gridContainer.className = "checkbox-grid";
        }

        question.options.forEach((option) => {
          const optionElement = document.createElement("label");
          optionElement.className = "checkbox-label"; // Use this class for checkbox labels
          const inputElement = document.createElement("input");
          inputElement.type = "checkbox";
          inputElement.name = question.id;
          inputElement.value = option;

          optionElement.appendChild(inputElement);
          optionElement.append(" " + option);

          gridContainer.appendChild(optionElement);
        });

        questionElement.appendChild(gridContainer);
        break;

      case "checkbox":
        question.options.forEach((option) => {
          inputElement = document.createElement("input");
          inputElement.type = "checkbox";
          inputElement.id = option;
          inputElement.value = option;
          questionElement.appendChild(inputElement);
          questionElement.appendChild(document.createTextNode(option));
        });
        break;

      case "input":
      case "email":
        inputElement = document.createElement("input");
        inputElement.type = question.type === "email" ? "email" : "text";
        inputElement.id = question.id;
        if (question.placeholder) {
          inputElement.placeholder = question.placeholder;
        }
        questionElement.appendChild(inputElement);
        break;

      case "radio":
        const flexContainer = document.createElement("div");
        flexContainer.className = "quiz-flex-container";

        // Set the direction of the flex container if specified
        if (question.direction) {
          flexContainer.style.flexDirection = question.direction;
        }

        question.options.forEach((option) => {
          const optionLabel = document.createElement("label");
          optionLabel.className = "quiz-button";
          optionLabel.textContent = option;

          const inputElement = document.createElement("input");
          inputElement.type = "radio";
          inputElement.name = question.id;
          inputElement.value = option;
          inputElement.onchange = () => {
            // Automatically move to the next question on selecting a radio option
            nextQuestion();
          };

          optionLabel.appendChild(inputElement);
          flexContainer.appendChild(optionLabel);
        });

        questionElement.appendChild(flexContainer);
        break;
    }

    // Append the fully constructed questionElement to the questionContainer
    questionContainer.appendChild(questionElement);

    if (currentQuestionIndex > 1) {
      document.getElementById("quiz-prev-question").style.display = "";
    } else {
      document.getElementById("quiz-prev-question").style.display = "none";
    }

    // Handle button enabling based on input and optional status
    const inputs = questionContainer.querySelectorAll(
      "input[type='text'], input[type='email'], input[type='radio'], input[type='checkbox']"
    );

    inputs.forEach((input) => {
      input.addEventListener("input", () => {
        // For text and email fields
        if (question.optional || input.value.trim().length > 0) {
          document.getElementById("quiz-next-question").disabled = false;
        } else {
          document.getElementById("quiz-next-question").disabled = true;
        }
      });

      input.addEventListener("change", () => {
        // For radio buttons and checkboxes
        if (question.type === "multipleChoice") {
          // Enable next if at least one checkbox is checked or if optional
          const anyChecked = Array.from(inputs).some((inp) => inp.checked);
          document.getElementById("quiz-next-question").disabled = !(
            anyChecked || question.optional
          );
        } else {
          document.getElementById("quiz-next-question").disabled = false;
        }
      });
    });
  }

  function submitQuiz() {
    // Create an object to store all answers
    const finalAnswers = {};

    // Go through each question and collect its answer
    questions.forEach((question) => {
      switch (question.type) {
        case "radio":
          const radioValue = document.querySelector(
            `input[name="${question.id}"]:checked`
          )?.value;
          if (radioValue) {
            finalAnswers[question.id] = radioValue;
          }
          break;

        case "multipleChoice":
          const checkboxes = document.querySelectorAll(
            `input[name="${question.id}"]:checked`
          );
          finalAnswers[question.id] = Array.from(checkboxes).map(
            (cb) => cb.value
          );
          break;

        case "input":
        case "email":
          const inputValue = document.getElementById(question.id)?.value;
          if (inputValue) {
            finalAnswers[question.id] = inputValue;
          }
          break;
      }
    });

    // Add any answers stored in the global answers object that might have been missed
    Object.assign(finalAnswers, answers);

    console.log("Quiz completed! Answers:");
    console.log(JSON.stringify(finalAnswers, null, 2));

    // Here you can add code to submit the answers to your backend
    // For example:
    // fetch('/api/submit-quiz', {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json',
    //   },
    //   body: JSON.stringify(finalAnswers)
    // });
  }

  displayQuestion(0); // Initialize with the first question

  window.addEventListener("popstate", function (event) {
    if (event.state) {
      displayQuestion(event.state.index);
    } else {
      // If there is no state, reset to the first question
      displayQuestion(0);
    }
  });
</script>

<style>
  .quiz-container {
    max-width: 600px;
    margin: 0 auto;
    overflow: hidden;
  }

  .quiz-progress-container {
    width: 100%;
    background-color: #ddd;
    height: 5px;
    margin-bottom: 20px;
  }

  .progress-bar {
    height: 100%;
    background-color: #ee3856;
    transition: width 0.5s ease-in-out;
  }

  #quiz-navigation-container {
    width: 100%;
    margin-top: 10px;
    display: flex;
    justify-content: flex-end; 
    gap: 10px;
  }

  .quiz-navbutton {
    font-size: 0.8em;
    padding: 10px 20px;
    background-color: #111; /*$brightPrim */
    color: white;
    cursor: pointer;
    border: none;
  }

  .quiz-flex-container {
    display: flex;
    gap: 10px;
    /* Allow items to wrap if they can't fit in a single line */
    flex-wrap: wrap;
  }

  .quiz-button {
    padding: 50px 15px;
    border-radius: 4px;
    background-color: #111; /*$brightPrim */
    color: white;
    white-space: nowrap;
    cursor: pointer;
    flex: 1; /* Makes buttons take up equal space */
    text-align: center;
    cursor: pointer;
    font-size: large;
  }

  .quiz-button:hover {
    background-color: #ee3856;
  }

  /* Convert to hand cursor on hover over the buttons or labels */
  input,
  .checkbox-label,
  .quiz-button:hover {
    cursor: pointer;
  }

  /* If the next button is disabled, change the cursor to not-allowed */
  #quiz-next-question:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }

  .quiz-button input[type="radio"] {
    display: none; /* Hide the actual radio button */
  }

  .quiz-container input[type="text"],
  .quiz-container input[type="email"] {
    font-size: larger;
    width: 100%; /* Fill the entire width */
    padding: 15px; /* Comfortable padding */
    border: 1px solid #000; /* 1px black border */
    box-sizing: border-box; /* Padding and border included in the width */
    margin-bottom: 20px; /* Space below each input */
  }

  /* Placeholder styling */
  .quiz-container input::placeholder {
    color: #ccc; /* Light grey placeholder text */
  }

  .question h2 {
    margin: 0;
  }

  /* Grid layout for checkboxes */
  .question .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
  }

  /* Custom larger checkbox style */
  .question input[type="checkbox"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    margin-right: 10px;
    width: 20px;
    height: 20px;
    border: 2px solid #111;
    border-radius: 4px;
    vertical-align: middle;
  }

  .question input[type="checkbox"]:checked {
    border: 2px solid #111;
    background-color: #ee3856;
  }

  /* Ensure inputs do not exceed the container's width on smaller screens */
  @media (max-width: 600px) {
    .quiz-container input[type="text"],
    .quiz-container input[type="email"] {
      width: calc(100% - 30px); /* Adjust width to account for padding */
    }
  }

  /* Dark mode styles */
  @media (prefers-color-scheme: dark) {
    .quiz-button {
      background-color: #fab71c;
      color: #111; /* Dark text */
    }

    .question input[type="checkbox"] {
      border-color: #fff; /* Light border */
    }

    .question input[type="checkbox"]:checked {
      border: 2px solid #fff;
      background-color: #ee3856;
    }
  }
</style>
