<div class="quiz-container">
  <div class="quiz-progress-container">
    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
  </div>
  <div id="quiz-question-container"></div>

  <div id="quiz-navigation-container">
    <button
      class="quiz-navbutton"
      id="quiz-prev-question"
      style="display: none"
    >
      Previous
    </button>
    <button class="quiz-navbutton" id="quiz-next-question">Next</button>
  </div>
</div>

<script>
  const languageOptions = [
    "Python",
    "Java",
    "C++",
    "Go",
    "TypeScript",
    "JavaScript",
    "C#",
    "Ruby",
    "PHP",
    "Swift",
    "Kotlin",
    "Other",
  ];

  {{ body | safe }}

// Quiz state
let answers = {};
let currentQuestionIndex = 0;
let totalQuestions;

// DOM elements
const progressBar = document.getElementById("progress-bar");
const questionContainer = document.getElementById("quiz-question-container");
const prevButton = document.getElementById("quiz-prev-question");
const nextButton = document.getElementById("quiz-next-question");

function initQuiz() {
  totalQuestions = questions.length;
  displayQuestion(0);

  nextButton.addEventListener("click", nextQuestion);
  prevButton.addEventListener("click", previousQuestion);
  
  // Handle browser back/forward buttons
  window.addEventListener("popstate", (event) => {
    if (event.state) {
      currentQuestionIndex = event.state.index;
      answers = event.state.answers || {};
      displayQuestion(currentQuestionIndex);
    } else {
      resetQuiz();
    }
  });
}

function resetQuiz() {
  answers = {};
  currentQuestionIndex = 0;
  displayQuestion(0);
}

function updateProgressBar() {
  const progressPercentage = ((currentQuestionIndex + 1) / totalQuestions) * 100;
  progressBar.style.width = `${progressPercentage}%`;
}

function saveCurrentAnswers() {
  const inputs = questionContainer.querySelectorAll("input");
  const questionId = questions[currentQuestionIndex].id;

  // Reset existing answers for this question
  answers[questionId] = undefined;

  inputs.forEach((input) => {
    if (input.type === "checkbox") {
      if (input.checked) {
        answers[questionId] = answers[questionId] || [];
        answers[questionId].push(input.value);
      }
    } else if ((input.type === "radio" && input.checked) || input.type === "text" || input.type === "email") {
      if (input.value.trim()) {
        answers[questionId] = input.value;
      }
    }
  });
}

function restorePreviousAnswers(question, container) {
  const previousAnswer = answers[question.id];
  if (!previousAnswer) return;

  const inputs = container.querySelectorAll("input");
  inputs.forEach(input => {
    if (input.type === "checkbox") {
      input.checked = previousAnswer.includes(input.value);
    } else if (input.type === "radio") {
      input.checked = input.value === previousAnswer;
    } else {
      input.value = previousAnswer;
    }
  });
}

function updateNavigationState() {
  prevButton.style.display = currentQuestionIndex > 0 ? "" : "none";
  const question = questions[currentQuestionIndex];
  nextButton.disabled = !isQuestionAnswered(question);
}

function isQuestionAnswered(question) {
  if (question.optional) return true;
  const answer = answers[question.id];
  if (!answer) return false;
  if (Array.isArray(answer)) return answer.length > 0;
  return answer.trim().length > 0;
}

function createQuestionElement(question) {
  const element = document.createElement("div");
  element.className = "question";
  element.innerHTML = `<h2>${question.question}${question.optional ? " (Optional)" : ""}</h2>`;

  let inputContainer;

  switch (question.type) {
    case "multipleChoice":
      inputContainer = document.createElement("div");
      if (question.direction) {
        inputContainer.style.display = "flex";
        inputContainer.style.flexDirection = question.direction;
      } else {
        inputContainer.className = "checkbox-grid";
      }
      
      question.options.forEach(option => {
        const label = document.createElement("label");
        label.className = "checkbox-label";
        
        const input = document.createElement("input");
        input.type = "checkbox";
        input.name = question.id;
        input.value = option;
        
        label.appendChild(input);
        label.append(` ${option}`);
        inputContainer.appendChild(label);
      });
      break;

    case "radio":
      inputContainer = document.createElement("div");
      inputContainer.className = "quiz-flex-container";
      if (question.direction) {
        inputContainer.style.flexDirection = question.direction;
      }

      question.options.forEach(option => {
        const label = document.createElement("label");
        label.className = "quiz-button";
        label.textContent = option;

        const input = document.createElement("input");
        input.type = "radio";
        input.name = question.id;
        input.value = option;
        
        // Auto-advance on radio selection
        input.addEventListener("change", () => {
          if (input.checked && currentQuestionIndex < totalQuestions - 1) {
            nextQuestion();
          }
        });

        label.appendChild(input);
        inputContainer.appendChild(label);
      });
      break;

    case "input":
    case "email":
      inputContainer = document.createElement("input");
      inputContainer.type = question.type;
      inputContainer.id = question.id;
      inputContainer.placeholder = question.placeholder || "";
      break;
  }

  element.appendChild(inputContainer);
  return { element, inputContainer };
}

function displayQuestion(index) {
  const question = questions[index];
  if (!question) return;

  // Save current state in history
  history.pushState(
    { index, answers: { ...answers } },
    `Question ${index + 1}`,
    `?question=${index + 1}`
  );

  questionContainer.innerHTML = "";
  const { element, inputContainer } = createQuestionElement(question);
  questionContainer.appendChild(element);

  // Restore previous answers if they exist
  restorePreviousAnswers(question, inputContainer);

  // Update UI state
  updateProgressBar();
  updateNavigationState();

  // Add input listeners
  const inputs = inputContainer.querySelectorAll("input");
  inputs.forEach(input => {
    const handler = () => {
      saveCurrentAnswers();
      updateNavigationState();
    };
    input.addEventListener("input", handler);
    input.addEventListener("change", handler);
  });
}

function nextQuestion() {
  if (currentQuestionIndex < totalQuestions - 1) {
    saveCurrentAnswers();
    currentQuestionIndex++;
    displayQuestion(currentQuestionIndex);
  } else {
    submitQuiz();
  }
}

function previousQuestion() {
  if (currentQuestionIndex > 0) {
    saveCurrentAnswers();
    currentQuestionIndex--;
    displayQuestion(currentQuestionIndex);
  }
}

function submitQuiz() {
  saveCurrentAnswers();
  console.log("Quiz completed! Answers:");
  console.log(JSON.stringify(answers, null, 2));
  
  // Here you would typically send the data to your backend
  // fetch('/api/submit-quiz', {
  //   method: 'POST',
  //   headers: { 'Content-Type': 'application/json' },
  //   body: JSON.stringify(answers)
  // });
}

// Start the quiz when the DOM is ready
document.addEventListener('DOMContentLoaded', initQuiz);

  displayQuestion(0); // Initialize with the first question

  window.addEventListener("popstate", function (event) {
    if (event.state) {
      displayQuestion(event.state.index);
    } else {
      // If there is no state, reset to the first question
      displayQuestion(0);
    }
  });
</script>

<style>
  .quiz-container {
    max-width: 600px;
    margin: 0 auto;
    overflow: hidden;
  }

  .quiz-progress-container {
    width: 100%;
    background-color: #ddd;
    height: 5px;
    margin-bottom: 20px;
  }

  .progress-bar {
    height: 100%;
    background-color: #ee3856;
    transition: width 0.5s ease-in-out;
  }

  #quiz-navigation-container {
    width: 100%;
    margin-top: 10px;
    display: flex;
    justify-content: flex-end; 
    gap: 10px;
  }

  .quiz-navbutton {
    font-size: 0.8em;
    padding: 10px 20px;
    background-color: #111; /*$brightPrim */
    color: white;
    cursor: pointer;
    border: none;
  }

  .quiz-flex-container {
    display: flex;
    gap: 10px;
    /* Allow items to wrap if they can't fit in a single line */
    flex-wrap: wrap;
  }

  .quiz-button {
    padding: 50px 15px;
    border-radius: 4px;
    background-color: #111; /*$brightPrim */
    color: white;
    white-space: nowrap;
    cursor: pointer;
    flex: 1; /* Makes buttons take up equal space */
    text-align: center;
    cursor: pointer;
    font-size: large;
  }

  .quiz-button:hover {
    background-color: #ee3856;
  }

  /* Convert to hand cursor on hover over the buttons or labels */
  input,
  .checkbox-label,
  .quiz-button:hover {
    cursor: pointer;
  }

  /* If the next button is disabled, change the cursor to not-allowed */
  #quiz-next-question:disabled {
    cursor: not-allowed;
    opacity: 0.5;
  }

  .quiz-button input[type="radio"] {
    display: none; /* Hide the actual radio button */
  }

  .quiz-container input[type="text"],
  .quiz-container input[type="email"] {
    font-size: larger;
    width: 100%; /* Fill the entire width */
    padding: 15px; /* Comfortable padding */
    border: 1px solid #000; /* 1px black border */
    box-sizing: border-box; /* Padding and border included in the width */
    margin-bottom: 20px; /* Space below each input */
  }

  /* Placeholder styling */
  .quiz-container input::placeholder {
    color: #ccc; /* Light grey placeholder text */
  }

  .question h2 {
    margin: 0;
  }

  /* Grid layout for checkboxes */
  .question .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
  }

  /* Custom larger checkbox style */
  .question input[type="checkbox"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    margin-right: 10px;
    width: 20px;
    height: 20px;
    border: 2px solid #111;
    border-radius: 4px;
    vertical-align: middle;
  }

  .question input[type="checkbox"]:checked {
    border: 2px solid #111;
    background-color: #ee3856;
  }

  /* Ensure inputs do not exceed the container's width on smaller screens */
  @media (max-width: 600px) {
    .quiz-container input[type="text"],
    .quiz-container input[type="email"] {
      width: calc(100% - 30px); /* Adjust width to account for padding */
    }
  }

  /* Dark mode styles */
  @media (prefers-color-scheme: dark) {
    .quiz-button {
      background-color: #fab71c;
      color: #111; /* Dark text */
    }

    .question input[type="checkbox"] {
      border-color: #fff; /* Light border */
    }

    .question input[type="checkbox"]:checked {
      border: 2px solid #fff;
      background-color: #ee3856;
    }
  }
</style>
